<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JARVIS WebAR – Gemelo Digital</title>

  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body{margin:0;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000}

    /* ===== JARVIS HUD ===== */
    .hudWrap{
      position:fixed; inset:0; pointer-events:none; z-index:10;
      color:#dff7ff;
    }
    .vignette{
      position:absolute; inset:-20%;
      background:
        radial-gradient(closest-side at 50% 50%, rgba(0,229,255,.06), rgba(0,0,0,.65) 65%, rgba(0,0,0,.92) 100%),
        radial-gradient(closest-side at 20% 20%, rgba(45,125,255,.08), rgba(0,0,0,0) 55%),
        radial-gradient(closest-side at 80% 30%, rgba(24,255,154,.06), rgba(0,0,0,0) 50%);
      filter: blur(0px);
    }
    .scan{
      position:absolute; left:-10%; right:-10%; top:-30%;
      height:38%;
      background: linear-gradient(to bottom,
        rgba(0,229,255,0) 0%,
        rgba(0,229,255,.10) 40%,
        rgba(0,229,255,.18) 50%,
        rgba(0,229,255,.08) 60%,
        rgba(0,229,255,0) 100%);
      transform: skewY(-4deg);
      animation: scanMove 2.6s linear infinite;
      mix-blend-mode: screen;
      opacity:.9;
    }
    @keyframes scanMove{
      0%{ transform: translateY(-10%) skewY(-4deg); opacity:.6; }
      60%{ opacity:1; }
      100%{ transform: translateY(240%) skewY(-4deg); opacity:.5; }
    }

    .topBar{
      position:absolute; left:14px; top:14px;
      padding:12px 14px; border-radius:16px;
      background: rgba(5,10,16,.55);
      border: 1px solid rgba(0,229,255,.20);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      max-width:min(520px, calc(100vw - 28px));
    }
    .topBar .t1{ font-weight:900; letter-spacing:.6px; font-size:16px; }
    .topBar .t2{ opacity:.85; font-size:12px; margin-top:4px; line-height:1.2; }
    .badgeRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .badge{
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px; opacity:.95;
    }
    .badge .dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; box-shadow:0 0 14px currentColor; }

    /* Panel derecho estilo JARVIS */
    .side{
      position:absolute; right:14px; top:14px; width:min(340px, calc(100vw - 28px));
      padding:12px 12px 10px; border-radius:16px;
      background: rgba(5,10,16,.48);
      border: 1px solid rgba(0,229,255,.16);
      backdrop-filter: blur(10px);
    }
    .side .h{ font-weight:900; letter-spacing:.4px; font-size:13px; opacity:.95; }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:8px; margin-top:10px; font-size:12px; }
    .kv div{ padding:8px 10px; border-radius:12px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); }
    .kv .v{ font-weight:900; color:#9deBff; }
    .hint{
      margin-top:10px; font-size:11px; opacity:.8; line-height:1.2;
      border-left:3px solid rgba(0,229,255,.45); padding-left:10px;
    }

    /* Tarjeta de selección */
    .card{
      position:absolute; left:14px; bottom:14px;
      width:min(520px, calc(100vw - 28px));
      padding:12px 12px 10px; border-radius:18px;
      background: rgba(5,10,16,.70);
      border:1px solid rgba(0,229,255,.18);
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      display:none;
    }
    .row{ display:flex; gap:10px; align-items:flex-start; }
    .statusDot{
      width:12px; height:12px; border-radius:50%;
      box-shadow:0 0 18px currentColor; margin-top:3px;
    }
    .title{ font-weight:1000; letter-spacing:.3px; }
    .sub{ font-size:12px; opacity:.86; margin-top:3px; }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .kpi{ flex:1; min-width: 140px; padding:10px; border-radius:14px;
      background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); }
    .kpi .k{ font-size:11px; opacity:.8; }
    .kpi .v{ font-size:16px; font-weight:1000; margin-top:2px; color:#9deBff; }
    .btnRow{ display:flex; gap:10px; margin-top:10px; pointer-events:auto; }
    .btn{
      pointer-events:auto;
      cursor:pointer; user-select:none;
      padding:10px 12px; border-radius:14px; font-weight:900; font-size:13px;
      border:1px solid rgba(0,229,255,.28);
      background: linear-gradient(135deg, rgba(0,229,255,.22), rgba(45,125,255,.14));
      color:#eaf6ff;
    }
    .btn.secondary{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      opacity:.95;
    }

    /* Oculta botón VR de A-Frame */
    .a-enter-vr-button{ display:none !important; }
  </style>
</head>

<body>
  <div class="hudWrap">
    <div class="vignette"></div>
    <div class="scan"></div>

    <div class="topBar">
      <div class="t1">JARVIS · GEMELO DIGITAL (WebAR)</div>
      <div class="t2">Apunta al portataza. Toca un activo para ver KPIs y estado (simulado).</div>
      <div class="badgeRow">
        <div class="badge"><span class="dot" style="color:#18ff9a;background:#18ff9a;"></span>OK</div>
        <div class="badge"><span class="dot" style="color:#ffb200;background:#ffb200;"></span>WARN</div>
        <div class="badge"><span class="dot" style="color:#ff3b3b;background:#ff3b3b;"></span>ALERT</div>
        <div class="badge"><span class="dot" style="color:#00e5ff;background:#00e5ff;"></span>Open Source</div>
      </div>
    </div>

    <div class="side">
      <div class="h">SYSTEM TELEMETRY</div>
      <div class="kv">
        <div>Tracking</div><div class="v" id="teleTrack">—</div>
        <div>Activos</div><div class="v" id="teleCount">—</div>
        <div>Alerts</div><div class="v" id="teleAlerts">—</div>
      </div>
      <div class="hint">Tip: evita reflejos. Si no engancha, aléjate 10–15 cm y vuelve.</div>
    </div>

    <div class="card" id="card">
      <div class="row">
        <div class="statusDot" id="cardDot" style="color:#00e5ff;background:#00e5ff;"></div>
        <div style="flex:1">
          <div class="title" id="cardTitle">—</div>
          <div class="sub" id="cardSub">—</div>
        </div>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="k">KPI</div><div class="v" id="kpi1">—</div></div>
        <div class="kpi"><div class="k">Estado</div><div class="v" id="kpi2">—</div></div>
        <div class="kpi"><div class="k">Última señal</div><div class="v" id="kpi3">—</div></div>
      </div>
      <div class="btnRow">
        <div class="btn" id="btnPing">PING</div>
        <div class="btn secondary" id="btnClose">CERRAR</div>
      </div>
    </div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets/targets.mind; autoStart: true;"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    renderer="antialias:true; alpha:true; colorManagement:true; physicallyCorrectLights:true;"
  >
    <!-- Luz -->
    <a-entity light="type: ambient; intensity: 1.1"></a-entity>
    <a-entity light="type: directional; intensity: 1.05" position="1.2 2.3 1.0"></a-entity>
    <a-entity light="type: point; intensity: 0.8; distance: 2.0" position="0 0.65 0.2"></a-entity>

    <!-- Target -->
    <a-entity mindar-image-target="targetIndex:0" id="target0">
      <!-- Plataforma holográfica (sin texto gigante en 3D) -->
      <a-entity id="stage">
        <a-plane rotation="-90 0 0" width="1.25" height="1.25"
          material="color:#07111d; opacity:0.22; transparent:true; metalness:0.15; roughness:0.25"></a-plane>

        <a-plane rotation="-90 0 0" width="1.16" height="1.16"
          material="color:#00e5ff; opacity:0.10; transparent:true; wireframe:true"></a-plane>

        <!-- Scan rings -->
        <a-ring position="0 0.01 0" rotation="-90 0 0" radius-inner="0.16" radius-outer="0.175"
          material="color:#00e5ff; opacity:0.55; transparent:true; emissive:#00e5ff; emissiveIntensity:0.85">
          <a-animation attribute="scale" to="3.4 3.4 3.4" dur="2400" easing="easeOutQuad" repeat="indefinite"></a-animation>
          <a-animation attribute="material.opacity" to="0.0" dur="2400" easing="easeOutQuad" repeat="indefinite"></a-animation>
        </a-ring>

        <a-ring position="0 0.012 0" rotation="-90 0 0" radius-inner="0.28" radius-outer="0.292"
          material="color:#2d7dff; opacity:0.25; transparent:true; emissive:#2d7dff; emissiveIntensity:0.65"></a-ring>
      </a-entity>

      <!-- Ciudad -->
      <a-entity id="cityRoot"></a-entity>
      <a-entity id="linkRoot"></a-entity>

      <!-- Partículas “energía” -->
      <a-entity id="particles"></a-entity>
    </a-entity>

    <!-- Cámara + cursor para tap -->
    <a-camera position="0 0 0" look-controls="enabled:false">
      <a-cursor raycaster="objects: .pickable" fuse="false"
        material="color:#00e5ff; opacity:0.9"></a-cursor>
    </a-camera>
  </a-scene>

  <script>
    // ====== Sonido tipo “JARVIS ping” (WebAudio) ======
    function pingSound(){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1760, ctx.currentTime + 0.10);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.20);
    }

    // ====== Geo utilities ======
    function llToMeters(lon, lat, centerLon, centerLat) {
      const R = 6378137;
      const dLat = (lat - centerLat) * Math.PI / 180;
      const dLon = (lon - centerLon) * Math.PI / 180;
      const x = dLon * R * Math.cos(centerLat * Math.PI/180);
      const z = dLat * R;
      return { x, z };
    }
    function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    // ====== HUD elements ======
    const teleTrack = document.getElementById('teleTrack');
    const teleCount = document.getElementById('teleCount');
    const teleAlerts = document.getElementById('teleAlerts');

    const card = document.getElementById('card');
    const cardDot = document.getElementById('cardDot');
    const cardTitle = document.getElementById('cardTitle');
    const cardSub = document.getElementById('cardSub');
    const kpi1 = document.getElementById('kpi1');
    const kpi2 = document.getElementById('kpi2');
    const kpi3 = document.getElementById('kpi3');
    document.getElementById('btnClose').onclick = () => card.style.display = 'none';
    document.getElementById('btnPing').onclick = () => pingSound();

    function setDot(status){
      const c = status === 'alert' ? '#ff3b3b' : (status === 'warn' ? '#ffb200' : '#18ff9a');
      cardDot.style.color = c;
      cardDot.style.background = c;
      cardDot.style.boxShadow = `0 0 18px ${c}`;
    }

    // ====== 3D builders (sci-fi, no cajas simples) ======
    function makeHexTower(x,z,height,status){
      const root = document.createElement('a-entity');
      root.setAttribute('position', `${x} 0 ${z}`);

      const color = status === 'alert' ? '#ff3b3b' : (status === 'warn' ? '#ffb200' : '#2d7dff');
      const glow  = status === 'alert' ? '#ff3b3b' : (status === 'warn' ? '#ffb200' : '#00e5ff');

      // Cuerpo: cilindro hexagonal (se ve futurista)
      const body = document.createElement('a-cylinder');
      body.setAttribute('radius', '0.055');
      body.setAttribute('height', height);
      body.setAttribute('segments-radial', '6');
      body.setAttribute('position', `0 ${height/2} 0`);
      body.setAttribute('material', `color:${color}; opacity:0.86; transparent:true; metalness:0.25; roughness:0.28; emissive:${glow}; emissiveIntensity:0.18`);
      body.classList.add('pickable');
      root.appendChild(body);

      // Corona superior (holo)
      const crown = document.createElement('a-torus');
      crown.setAttribute('radius', '0.055');
      crown.setAttribute('radius-tubular', '0.004');
      crown.setAttribute('rotation', '90 0 0');
      crown.setAttribute('position', `0 ${height + 0.02} 0`);
      crown.setAttribute('material', `color:${glow}; opacity:0.55; transparent:true; emissive:${glow}; emissiveIntensity:0.85`);
      crown.setAttribute('animation', 'property: rotation; to: 90 360 0; loop:true; dur: 5200; easing: linear');
      root.appendChild(crown);

      // Beam vertical (tipo holograma)
      const beam = document.createElement('a-cylinder');
      beam.setAttribute('radius', '0.014');
      beam.setAttribute('height', (height*0.55));
      beam.setAttribute('position', `0 ${height + (height*0.55)/2} 0`);
      beam.setAttribute('material', `color:${glow}; opacity:0.14; transparent:true; emissive:${glow}; emissiveIntensity:0.8`);
      root.appendChild(beam);

      // Base ring
      const ring = document.createElement('a-ring');
      ring.setAttribute('rotation', '-90 0 0');
      ring.setAttribute('radius-inner', '0.045');
      ring.setAttribute('radius-outer', '0.053');
      ring.setAttribute('position', `0 0.012 0`);
      ring.setAttribute('material', `color:${glow}; opacity:0.45; transparent:true; emissive:${glow}; emissiveIntensity:0.85`);
      ring.setAttribute('animation', 'property: rotation; to: -90 360 0; loop:true; dur: 6200; easing: linear');
      root.appendChild(ring);

      return { root, pick: body };
    }

    function makeIoTNode(x,z,status){
      const root = document.createElement('a-entity');
      root.setAttribute('position', `${x} 0 ${z}`);

      const glow = status === 'alert' ? '#ff3b3b' : (status === 'warn' ? '#ffb200' : '#18ff9a');

      const core = document.createElement('a-sphere');
      core.setAttribute('radius', '0.022');
      core.setAttribute('position', `0 0.035 0`);
      core.setAttribute('material', `color:${glow}; emissive:${glow}; emissiveIntensity:1.0; metalness:0.1; roughness:0.22; opacity:0.95; transparent:true`);
      core.setAttribute('animation', 'property: scale; to: 1.35 1.35 1.35; dir: alternate; loop: true; dur: 900; easing: easeInOutSine');
      core.classList.add('pickable');
      root.appendChild(core);

      // Ondas tipo radar
      const wave = document.createElement('a-ring');
      wave.setAttribute('rotation', '-90 0 0');
      wave.setAttribute('radius-inner', '0.014');
      wave.setAttribute('radius-outer', '0.020');
      wave.setAttribute('position', `0 0.012 0`);
      wave.setAttribute('material', `color:${glow}; opacity:0.55; transparent:true; emissive:${glow}; emissiveIntensity:0.9`);
      wave.setAttribute('animation__s', 'property: scale; to: 3.3 3.3 3.3; loop:true; dur: 1500; easing: easeOutQuad');
      wave.setAttribute('animation__o', 'property: material.opacity; to: 0.0; loop:true; dur: 1500; easing: easeOutQuad');
      root.appendChild(wave);

      // Antena
      const ant = document.createElement('a-cylinder');
      ant.setAttribute('radius', '0.004');
      ant.setAttribute('height', '0.10');
      ant.setAttribute('position', `0 0.06 0`);
      ant.setAttribute('material', 'color:#07111d; opacity:0.35; transparent:true; metalness:0.2; roughness:0.4');
      root.appendChild(ant);

      return { root, pick: core };
    }

    function makeLink(x1,z1,x2,z2,color){
      const e = document.createElement('a-entity');
      e.setAttribute('line', `start: ${x1} 0.04 ${z1}; end: ${x2} 0.12 ${z2}; color: ${color}; opacity: 0.65`);
      return e;
    }

    // Partículas simples (energía)
    function spawnParticles(container, count){
      container.innerHTML = "";
      for(let i=0;i<count;i++){
        const p = document.createElement('a-sphere');
        const x = (Math.random()*1.0 - 0.5) * 0.9;
        const z = (Math.random()*1.0 - 0.5) * 0.9;
        const y = 0.02 + Math.random()*0.20;
        p.setAttribute('radius', 0.004 + Math.random()*0.004);
        p.setAttribute('position', `${x} ${y} ${z}`);
        p.setAttribute('material', 'color:#00e5ff; opacity:0.22; transparent:true; emissive:#00e5ff; emissiveIntensity:0.8');
        p.setAttribute('animation', `property: position; to: ${x} ${y+0.08} ${z}; dir: alternate; loop:true; dur:${1200+Math.random()*1200}; easing: easeInOutSine`);
        container.appendChild(p);
      }
    }

    async function boot() {
      const res = await fetch('./data/demo.geojson');
      const gj = await res.json();

      const feats = (gj.features || []).filter(f => f.geometry?.type === 'Point');
      const coords = feats.map(f => f.geometry.coordinates);

      // center
      const avgLon = coords.reduce((s,c)=>s+c[0],0) / coords.length;
      const avgLat = coords.reduce((s,c)=>s+c[1],0) / coords.length;

      // Ajuste de densidad en mesa (JARVIS look)
      const SCALE = 0.013; // cambia a 0.015 si quieres más separación

      const points = feats.map((f, idx) => {
        const [lon, lat] = f.geometry.coordinates; // OJO: lon,lat
        const m = llToMeters(lon, lat, avgLon, avgLat);
        const x = m.x * SCALE;
        const z = -m.z * SCALE;

        const p = f.properties || {};
        const type = p.type || 'sensor';
        const hMeters = clamp(Number(p.h || 3), 1, 60);

        // Altura “dramática” (más JARVIS)
        const heightUnits = (hMeters * SCALE) * 1.9;

        const status = p.status || (Math.random()<0.12 ? 'alert' : (Math.random()<0.22 ? 'warn' : 'ok'));
        const kpi = (type === 'building') ? `${randInt(68, 99)}%` : `${randInt(12, 86)}ms`;
        const lastSeen = `${randInt(1, 59)}s`;

        return { id: idx+1, name: p.name || `Nodo ${idx+1}`, type, x, z, heightUnits, status, kpi, lastSeen };
      });

      // telemetry hud
      teleCount.textContent = points.length;
      teleAlerts.textContent = points.filter(p => p.status === 'alert').length;

      const cityRoot = document.getElementById('cityRoot');
      const linkRoot = document.getElementById('linkRoot');
      const particles = document.getElementById('particles');
      cityRoot.innerHTML = "";
      linkRoot.innerHTML = "";

      // Partículas
      spawnParticles(particles, 26);

      // Links: sensores -> edificio más cercano (IoT)
      const buildings = points.filter(p => p.type === 'building');
      const sensors = points.filter(p => p.type !== 'building');

      sensors.forEach(s => {
        let best=null, bestD=Infinity;
        buildings.forEach(b => {
          const dx=s.x-b.x, dz=s.z-b.z;
          const d=dx*dx+dz*dz;
          if(d<bestD){ bestD=d; best=b; }
        });
        if(best){
          const c = (s.status==='alert'||best.status==='alert') ? '#ff3b3b' : '#00e5ff';
          linkRoot.appendChild(makeLink(s.x,s.z,best.x,best.z,c));
        }
      });

      // Render
      points.forEach(pt => {
        let built;
        if(pt.type === 'building'){
          built = makeHexTower(pt.x, pt.z, pt.heightUnits, pt.status);
        } else {
          built = makeIoTNode(pt.x, pt.z, pt.status);
        }

        built.pick.dataset.meta = JSON.stringify(pt);
        built.pick.addEventListener('click', () => {
          const m = JSON.parse(built.pick.dataset.meta);
          setDot(m.status);
          cardTitle.textContent = m.name;
          cardSub.textContent = (m.type === 'building') ? 'Infraestructura / Activo crítico' : 'Sensor / IoT';
          kpi1.textContent = (m.type === 'building') ? `${m.kpi} carga` : `${m.kpi} latencia`;
          kpi2.textContent = m.status.toUpperCase();
          kpi3.textContent = m.lastSeen;
          card.style.display = 'block';
          pingSound();
          // punch
          built.pick.setAttribute('animation__p', 'property: scale; to: 1.25 1.25 1.25; dir: alternate; dur: 160; loop: 2; easing: easeOutQuad');
        });

        cityRoot.appendChild(built.root);
      });

      // Tracking status: MindAR emite eventos
      const target = document.getElementById('target0');
      target.addEventListener('targetFound', () => { teleTrack.textContent = 'LOCK'; });
      target.addEventListener('targetLost',  () => { teleTrack.textContent = 'SEARCH'; });
      teleTrack.textContent = 'SEARCH';
    }

    boot().catch(console.error);
  </script>
</body>
</html>
